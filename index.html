<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GRUPO RUGIDO — Calculadora de Faturamento+</title>

  <!-- Fonte -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <!-- Chart.js e html2canvas (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    /* =========================
        THEME TOKENS
        ========================= */
    :root {
      --bg: #0f172a;
      --panel: #1e293b;
      --ink: #e2e8f0;
      --muted: #94a3b8;
      --accent: #22c55e;
      --accent-2: #4ade80;
      --border: #334155;
      --rail: #475569;
      --thumb: #a3e635;
      --bad: #ef4444;
      --warn: #f59e0b;
      --ok: #10b981;
      --card: #111827;
      --chip: #0b1222;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    html[data-theme="light"] {
      --bg: #f8fafc;
      --panel: #ffffff;
      --ink: #0f172a;
      --muted: #475569;
      --accent: #059669;
      --accent-2: #34d399;
      --border: #e2e8f0;
      --rail: #e5e7eb;
      --thumb: #84cc16;
      --bad: #dc2626;
      --warn: #d97706;
      --ok: #059669;
      --card: #f8fafc;
      --chip: #eef2ff;
      --shadow: 0 8px 20px rgba(0,0,0,.08);
    }

    /* =========================
        RESET & BASE
        ========================= */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, rgba(34,197,94,.08), transparent 50%),
                  radial-gradient(800px 600px at 110% 10%, rgba(79,70,229,.08), transparent 50%),
                  var(--bg);
      color: var(--ink);
      padding: 24px;
    }
    .container {
      max-width: 1280px;
      margin: 0 auto;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 18px;
    }

    /* Estilo para preparar a exportação de PNG */
    body.is-exporting {
        background: var(--bg) !important;
    }

    /* =========================
        TOPBAR
        ========================= */
    .topbar {
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow);
    }
    .title {
      display: flex; gap: 12px; align-items: center;
      font-weight: 700; letter-spacing: -.3px;
    }
    .actions { display: flex; flex-wrap: wrap; gap: 8px; }

    .btn {
      appearance: none; border: 1px solid var(--border);
      background: var(--card); color: var(--ink);
      padding: 10px 14px; border-radius: 10px; font-weight: 600;
      cursor: pointer; transition: .2s ease; display: inline-flex; gap: 8px; align-items: center;
    }
    .btn:hover { transform: translateY(-1px); border-color: var(--accent); }
    .btn.primary { background: linear-gradient(45deg, var(--accent), var(--accent-2)); color: #022c22; border-color: transparent; }
    .btn.ghost { background: transparent; }
    .btn.warn:hover { border-color: var(--bad); color: var(--bad); }

    .switch {
      display: inline-flex; gap: 10px; align-items: center; font-weight: 600; color: var(--muted);
      user-select: none;
    }
    .switch input { display: none; }
    .switch .track {
      width: 46px; height: 26px; background: var(--rail); border-radius: 999px; position: relative;
      transition: .2s ease;
    }
    .switch .thumb {
      position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; 
      background: var(--thumb); border-radius: 50%; transition: .2s ease;
      box-shadow: 0 0 10px rgba(132,204,22,.5);
    }
    .switch input:checked + .track .thumb { transform: translateX(20px); }

    /* =========================
        LAYOUT
        ========================= */
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 1fr);
      gap: 20px;
    }
    @media (max-width: 1080px) { .grid { grid-template-columns: 1fr; } }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 20px;
    }

    /* =========================
        INPUTS (LEFT)
        ========================= */
    .section-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; display:flex; align-items:center; gap:8px;}
    .section-sub { color: var(--muted); font-size: 13px; margin-bottom: 18px; }

    .group { border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 14px; background: linear-gradient(180deg, rgba(255,255,255,.02), transparent); }
    .group h4 { font-size: 14px; color: var(--muted); margin-bottom: 10px; font-weight: 700; letter-spacing: .2px; text-transform: uppercase; }

    .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; margin-bottom: 10px; position: relative; }
    .lbl { font-weight: 600; }
    .hint { font-size: 12px; color: var(--muted); margin-top: -6px; grid-column: 1 / -1; }

    .num { width: 120px; padding: 10px; text-align: center; font-weight: 700; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--ink); }
    .num:focus { outline: none; border-color: var(--thumb); box-shadow: 0 0 0 3px rgba(163,230,53,.2); }
    .num:disabled { opacity: .6; cursor: not-allowed; }

    .range { grid-column: 1 / -1; -webkit-appearance: none; appearance: none; height: 8px; border-radius: 6px; background: var(--rail); }
    .range::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--thumb); border: 4px solid var(--panel); box-shadow: 0 0 8px rgba(163,230,53,.5); transition: .15s; }
    .range:active::-webkit-slider-thumb { transform: scale(1.1); }
    .range:disabled::-webkit-slider-thumb { background: var(--muted); }


    .check { display:flex; gap:8px; align-items:center; font-size: 13px; color: var(--muted); margin-top: 6px; }
    .check input { accent-color: var(--thumb); }

    .chip {
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px; border-radius: 999px; border:1px solid var(--border);
      background: var(--chip); color: var(--muted); font-size: 12px; font-weight: 600;
    }

    /* =========================
        KPIs (RIGHT) & TABS
        ========================= */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .tab-btn {
      padding: 8px 16px;
      border: none;
      background: none;
      color: var(--muted);
      font-weight: 600;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: .2s ease;
    }
    .tab-btn:hover { color: var(--ink); }
    .tab-btn.active {
      color: var(--accent-2);
      border-bottom-color: var(--accent-2);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .kpi-dashboard {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
    }
    .kpi-card {
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        text-align: center;
        overflow: hidden;
    }
    .kpi-card.main {
        grid-column: 1 / -1;
        background: linear-gradient(45deg, var(--accent), var(--accent-2));
        color: #022c22;
        justify-content: center;
    }
    .kpi-card .label {
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: .4px;
        opacity: .8;
    }
    .kpi-card .value {
        font-size: clamp(1.1rem, 2.5vw, 1.5rem);
        font-weight: 800;
        line-height: 1.2;
        white-space: nowrap;
    }
    .kpi-card.main .value {
        font-size: clamp(1.8rem, 5vw, 2.8rem);
    }
    .kpi-card .sub-value {
        font-size: clamp(1rem, 3vw, 1.2rem);
        font-weight: 700;
        opacity: .9;
    }
    .pos { color: var(--ok); } 
    .neg { color: var(--bad); }
    html[data-theme="light"] .kpi-card.main .neg { color: var(--bad); }


    /* =========================
        CHARTS + SENSI
        ========================= */
    .charts { display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top: 10px; }
    @media (max-width: 1080px) { .charts { grid-template-columns: 1fr; } }

    .card { border:1px solid var(--border); border-radius: 14px; padding: 14px; background: var(--bg); }
    .card h5 { font-size: 14px; color: var(--muted); margin-bottom: 8px; font-weight: 700; text-transform: uppercase; }

    .sensi {
      overflow:auto; border:1px solid var(--border); border-radius:14px; background: var(--bg);
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { border-bottom: 1px solid var(--border); padding: 10px; text-align: center; white-space: nowrap; }
    th { background: linear-gradient(180deg, rgba(255,255,255,.02), transparent); position: sticky; top: 0; z-index: 1; }
    td.good { background: rgba(16,185,129,.08); }
    td.mid  { background: rgba(245,158,11,.08); }
    td.bad  { background: rgba(239,68,68,.08); }

    /* =========================
        FOOT
        ========================= */
    .foot { color: var(--muted); font-size: 12px; display:flex; justify-content:center; gap:8px; opacity:.8; }
  </style>
</head>
<body>
  <div class="container">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="title">
        <span>📈 GRUPO RUGIDO</span>
      </div>
      <div class="actions">
        <label class="switch" title="Alternar tema">
          <input id="themeToggle" type="checkbox" />
          <span class="track"><span class="thumb"></span></span>
          <span>Claro</span>
        </label>
        <button class="btn" id="shareLink">Compartilhar link</button>
        <button class="btn warn" id="resetAll">Reset</button>
        <button class="btn primary" id="exportPNG">Exportar PNG</button>
      </div>
    </div>

    <!-- GRID -->
    <div class="grid" id="mainGrid">
      <!-- LEFT: ENTRADAS -->
      <div class="panel" id="inputsPanel">
        <div class="section-title">Entradas</div>
        <div class="section-sub">Ajuste os controles e veja os resultados em tempo real.</div>

        <!-- Investimento -->
        <div class="group">
          <h4>Investimento</h4>

          <div class="row">
            <div class="lbl">Investimento em Mídia (R$)</div>
            <input class="num" id="spendNum" type="number" min="0" max="10000000" step="100" value="89700" />
            <input class="range" id="spendRange" type="range" min="0" max="200000" step="100" value="89700" />
          </div>

          <div class="row">
            <div class="lbl">CPL (R$)</div>
            <input class="num" id="cplNum" type="number" min="0" max="1000" step="1" value="21.04" />
            <input class="range" id="cplRange" type="range" min="0" max="1000" step="1" value="21.04" />
            <div class="check"><input id="cplAuto" type="checkbox" checked /> <label for="cplAuto">Calcular CPL automaticamente</label></div>
            <p class="hint">Desmarque para digitar o CPL e calcular os leads.</p>
          </div>

          <div class="row">
            <div class="lbl">Margem Bruta (%)</div>
            <input class="num" id="marginNum" type="number" min="0" max="100" step="1" value="60" />
            <input class="range" id="marginRange" type="range" min="0" max="100" step="1" value="60" />
          </div>

          <div class="row">
            <div class="lbl">Custos Fixos (R$)</div>
            <input class="num" id="fixedNum" type="number" min="0" max="1000000" step="1000" value="20000" />
            <input class="range" id="fixedRange" type="range" min="0" max="100000" step="1000" value="20000" />
          </div>
        </div>
        
        <!-- Demanda -->
        <div class="group">
          <h4>Demanda</h4>

          <div class="row">
            <div class="lbl">Leads</div>
            <input class="num" id="leadsNum" type="number" min="0" max="100000" step="100" value="4263" />
            <input class="range" id="leadsRange" type="range" min="0" max="10000" step="100" value="4263" />
          </div>

          <div class="row">
            <div class="lbl">Conversão (%)</div>
            <input class="num" id="convNum" type="number" min="0" max="100" step="0.1" value="9.97" />
            <input class="range" id="convRange" type="range" min="0" max="100" step="0.1" value="9.97" />
          </div>

          <div class="row">
            <div class="lbl">
              Vendas
              <span class="chip" title="Quando automático, Vendas = Leads × Conversão">auto</span>
            </div>
            <input class="num" id="salesNum" type="number" min="0" max="10000" step="10" value="425" />
            <input class="range" id="salesRange" type="range" min="0" max="1000" step="10" value="425" />
            <div class="check"><input id="salesAuto" type="checkbox" checked /> <label for="salesAuto">Calcular vendas automaticamente</label></div>
          </div>
        </div>

        <!-- Receita -->
        <div class="group">
          <h4>Receita</h4>

          <div class="row">
            <div class="lbl">Ticket Médio (R$)</div>
            <input class="num" id="ticketNum" type="number" min="0" max="100000" step="100" value="3760" />
            <input class="range" id="ticketRange" type="range" min="0" max="10000" step="100" value="3760" />
          </div>

          <div class="row">
            <div class="lbl">
              LTV — Nº de compras por cliente
              <span class="chip" title="Multiplica a receita por recorrência média de compras por cliente.">ajuda</span>
            </div>
            <input class="num" id="ltvNum" type="number" min="1" max="60" step="1" value="1" />
            <input class="range" id="ltvRange" type="range" min="1" max="60" step="1" value="1" />
          </div>

          <div class="row">
            <div class="lbl">
              Cancelamentos/Devoluções (%)
            </div>
            <input class="num" id="cancelNum" type="number" min="0" max="100" step="1" value="0" />
            <input class="range" id="cancelRange" type="range" min="0" max="100" step="1" value="0" />
          </div>
        </div>
        
        <!-- Metas -->
        <div class="group">
          <h4>Metas</h4>
          <div class="row">
            <div class="lbl">Faturamento Meta (R$)</div>
            <input class="num" id="targetRevenueNum" type="number" min="0" max="50000000" step="10000" value="2000000" />
            <input class="range" id="targetRevenueRange" type="range" min="0" max="5000000" step="10000" value="2000000" />
          </div>
        </div>
      </div>

      <!-- RIGHT: RESULTADOS -->
      <div class="panel" id="resultsPanel">
        <div class="tabs">
          <button class="tab-btn active" data-tab="summary">Resumo</button>
          <button class="tab-btn" data-tab="analysis">Análise</button>
        </div>

        <!-- VIEW: RESUMO -->
        <div id="view-summary" class="tab-content active">
          <div class="kpi-dashboard">
            <div class="kpi-card main">
              <div class="label">Faturamento Estimado</div>
              <div id="kpiRevenue" class="value">R$ 0,00</div>
              <div id="kpiROASMain" class="sub-value">0,00x</div>
            </div>
            <div class="kpi-card">
              <div class="label">Vendas</div>
              <div id="kpiSales" class="value">0</div>
            </div>
            <div class="kpi-card">
              <div class="label">Leads</div>
              <div id="kpiLeads" class="value">0</div>
            </div>
            <div class="kpi-card">
              <div class="label">% Meta Atingida</div>
              <div id="kpiTargetPct" class="value">0%</div>
            </div>
            <div class="kpi-card">
              <div class="label">CPL</div>
              <div id="kpiCPL" class="value">R$ 0,00</div>
            </div>
            <div class="kpi-card">
              <div class="label">CPA</div>
              <div id="kpiCPA" class="value">R$ 0,00</div>
            </div>
             <div class="kpi-card">
              <div class="label">ROAS</div>
              <div id="kpiROAS" class="value">0,00x</div>
            </div>
            <div class="kpi-card">
              <div class="label">ROI %</div>
              <div id="kpiROI" class="value">0%</div>
            </div>
            <div class="kpi-card">
              <div class="label">Lucro Bruto</div>
              <div id="kpiGross" class="value">R$ 0,00</div>
            </div>
            <div class="kpi-card">
              <div class="label">Lucro Líquido</div>
              <div id="kpiNet" class="value">R$ 0,00</div>
            </div>
            <div class="kpi-card">
              <div class="label">Breakeven Receita</div>
              <div id="kpiBreakevenRev" class="value">R$ 0,00</div>
            </div>
            <div class="kpi-card">
              <div class="label">Breakeven Vendas</div>
              <div id="kpiBreakevenSales" class="value">0</div>
            </div>
          </div>
        </div>

        <!-- VIEW: ANÁLISE -->
        <div id="view-analysis" class="tab-content">
            <div class="charts">
              <div class="card">
                <h5>Receita vs Custos</h5>
                <canvas id="revChart" height="160"></canvas>
              </div>
              <div class="card">
                <h5>Funil: Leads → Vendas</h5>
                <canvas id="funnelChart" height="160"></canvas>
              </div>
            </div>
            <div class="card sensi" style="margin-top: 16px;">
              <h5>Simulador de Sensibilidade — Faturamento por Ticket × Conversão</h5>
              <div id="sensiWrap" style="padding: 8px 8px 14px 8px;">
                <table id="sensiTable"></table>
              </div>
            </div>
        </div>

      </div>
    </div>

    <div class="foot">
      <span>Feito com 💚 para o GRUPO RUGIDO • Ajuste e salve cenários.</span>
    </div>
  </div>

  <script>
    // =========================
    // HELPERS
    // =========================
    const fmtBRL = (v) => (isFinite(v) ? v : 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const fmtPct = (v) => `${(isFinite(v)?v:0).toFixed(1).replace('.', ',')}%`;
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

    // Getters
    const byId = (id) => document.getElementById(id);

    // Inputs
    const inputs = {
      leadsNum: byId('leadsNum'), leadsRange: byId('leadsRange'),
      convNum: byId('convNum'), convRange: byId('convRange'),
      salesNum: byId('salesNum'), salesRange: byId('salesRange'), salesAuto: byId('salesAuto'),
      ticketNum: byId('ticketNum'), ticketRange: byId('ticketRange'),
      ltvNum: byId('ltvNum'), ltvRange: byId('ltvRange'),
      cancelNum: byId('cancelNum'), cancelRange: byId('cancelRange'),
      spendNum: byId('spendNum'), spendRange: byId('spendRange'),
      cplNum: byId('cplNum'), cplRange: byId('cplRange'), cplAuto: byId('cplAuto'),
      marginNum: byId('marginNum'), marginRange: byId('marginRange'),
      fixedNum: byId('fixedNum'), fixedRange: byId('fixedRange'),
      targetRevenueNum: byId('targetRevenueNum'), targetRevenueRange: byId('targetRevenueRange'),
    };

    // KPIs
    const KPIs = {
      revenue: byId('kpiRevenue'),
      sales: byId('kpiSales'),
      leads: byId('kpiLeads'),
      targetPct: byId('kpiTargetPct'),
      cpl: byId('kpiCPL'),
      cpa: byId('kpiCPA'),
      roas: byId('kpiROAS'),
      roasMain: byId('kpiROASMain'),
      roi: byId('kpiROI'),
      gross: byId('kpiGross'),
      net: byId('kpiNet'),
      beRev: byId('kpiBreakevenRev'),
      beSales: byId('kpiBreakevenSales'),
    };

    // Theme
    const themeToggle = byId('themeToggle');
    themeToggle.addEventListener('change', () => {
      document.documentElement.setAttribute('data-theme', themeToggle.checked ? 'light' : 'dark');
      onChange(); // Re-render charts with new theme colors
    });

    // =========================
    // TABS
    // =========================
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            const tab = button.dataset.tab;
            tabContents.forEach(content => {
                content.classList.remove('active');
                if (content.id === `view-${tab}`) {
                    content.classList.add('active');
                }
            });
        });
    });

    // =========================
    // STATE & CALC
    // =========================
    function readState() {
      const spend = +inputs.spendNum.value || 0;
      const cplAuto = inputs.cplAuto.checked;
      let leads, cpl;

      if (cplAuto) {
        leads = +inputs.leadsNum.value || 0;
        cpl = leads > 0 ? spend / leads : 0;
        inputs.cplNum.value = cpl.toFixed(2);
        inputs.cplRange.value = cpl.toFixed(2);
      } else {
        cpl = +inputs.cplNum.value || 0;
        leads = cpl > 0 ? spend / cpl : 0;
        inputs.leadsNum.value = leads.toFixed(0);
        inputs.leadsRange.value = leads.toFixed(0);
      }

      const conv = clamp(+inputs.convNum.value || 0, 0, 100);
      const salesAuto = inputs.salesAuto.checked;
      const salesManual = +inputs.salesNum.value || 0;

      let sales = salesAuto ? leads * (conv / 100) : salesManual;
      if(inputs.salesAuto.checked) {
        inputs.salesRange.value = sales.toFixed(0);
        inputs.salesNum.value = sales.toFixed(0);
      } else {
        const newConv = leads > 0 ? (sales / leads) * 100 : 0;
        inputs.convNum.value = newConv.toFixed(2);
        inputs.convRange.value = newConv.toFixed(2);
      }

      const ticket = +inputs.ticketNum.value || 0;
      const ltv = clamp(+inputs.ltvNum.value || 1, 1, 60);
      const cancelPct = clamp(+inputs.cancelNum.value || 0, 0, 100);
      const marginPct = clamp(+inputs.marginNum.value || 0, 0, 100);
      const fixed = +inputs.fixedNum.value || 0;
      const targetRevenue = +inputs.targetRevenueNum.value || 0;
      const effectiveSales = sales * (1 - cancelPct / 100);
      const revenue = effectiveSales * ticket * ltv;
      const roas = spend > 0 ? revenue / spend : 0;
      const roiPct = spend > 0 ? ((revenue - spend) / spend) * 100 : 0;
      const grossProfit = revenue * (marginPct / 100);
      const netProfit = grossProfit - spend - fixed;
      const beRevenue = (spend + fixed) / (marginPct / 100 || 1);
      const beSales = ticket * ltv > 0 ? beRevenue / (ticket * ltv) : 0;

      return {
        leads, conv, sales, ticket, ltv, cancelPct, spend, cpl, marginPct, fixed, targetRevenue,
        revenue, roas, roiPct, grossProfit, netProfit, beRevenue, beSales
      };
    }

    function updateUI(s) {
      KPIs.revenue.textContent = fmtBRL(s.revenue);
      KPIs.sales.textContent = Math.round(s.sales).toLocaleString('pt-BR');
      KPIs.leads.textContent = Math.round(s.leads).toLocaleString('pt-BR');

      const targetPct = s.targetRevenue > 0 ? (s.revenue / s.targetRevenue) * 100 : 0;
      KPIs.targetPct.textContent = fmtPct(targetPct);
      KPIs.targetPct.parentElement.classList.toggle('pos', targetPct >= 100);
      KPIs.targetPct.parentElement.classList.toggle('neg', targetPct < 100);

      KPIs.cpl.textContent = fmtBRL(s.cpl);
      const cpa = s.sales > 0 ? s.spend / s.sales : 0;
      KPIs.cpa.textContent = fmtBRL(cpa);
      const roasText = `${(s.roas || 0).toFixed(2).replace('.',',')}x`;
      KPIs.roas.textContent = roasText;
      KPIs.roasMain.textContent = roasText;
      KPIs.roi.textContent = fmtPct(s.roiPct);

      KPIs.gross.textContent = fmtBRL(s.grossProfit);
      KPIs.net.textContent = fmtBRL(s.netProfit);
      KPIs.net.parentElement.classList.toggle('pos', s.netProfit >= 0);
      KPIs.net.parentElement.classList.toggle('neg', s.netProfit < 0);

      KPIs.beRev.textContent = fmtBRL(s.beRevenue);
      KPIs.beSales.textContent = Math.ceil(s.beSales).toLocaleString('pt-BR');

      renderCharts(s);
      renderSensitivity(s);
    }

    // =========================
    // SYNC INPUTS
    // =========================
    function bindPair(numEl, rangeEl, cb) {
      const sync = () => { if(parseFloat(numEl.value) > parseFloat(numEl.max)) numEl.value = rangeEl.max; rangeEl.value = numEl.value; cb(); };
      const syncR = () => { numEl.value = rangeEl.value; cb(); };

      numEl.addEventListener('input', sync);
      rangeEl.addEventListener('input', syncR);
    }

    [
      ['leadsNum','leadsRange'],
      ['convNum','convRange'],
      ['salesNum','salesRange'],
      ['ticketNum','ticketRange'],
      ['ltvNum','ltvRange'],
      ['cancelNum','cancelRange'],
      ['spendNum','spendRange'],
      ['cplNum','cplRange'],
      ['marginNum','marginRange'],
      ['fixedNum','fixedRange'],
      ['targetRevenueNum', 'targetRevenueRange'],
    ].forEach(([n, r]) => bindPair(inputs[n], inputs[r], onChange));

    inputs.salesAuto.addEventListener('change', () => {
      inputs.salesNum.disabled = inputs.salesAuto.checked;
      inputs.salesRange.disabled = inputs.salesAuto.checked;
      onChange();
    });

    inputs.cplAuto.addEventListener('change', () => {
      const isAuto = inputs.cplAuto.checked;
      inputs.cplNum.disabled = isAuto;
      inputs.cplRange.disabled = isAuto;
      inputs.leadsNum.disabled = !isAuto;
      inputs.leadsRange.disabled = !isAuto;
      onChange();
    });

    function onChange() {
        const s = readState();
        updateUI(s);
    }

    // =========================
    // CHARTS
    // =========================
    let revChart, funnelChart;

    function renderCharts(s) {
      const revCtx = byId('revChart').getContext('2d');
      const funCtx = byId('funnelChart').getContext('2d');

      const costCOGS = s.revenue - s.grossProfit;
      const fixed = s.fixed;
      const media = s.spend;
      const net = s.netProfit;

      const palette = getPalette();

      const revData = {
        labels: ['Receita', 'Custo Variável', 'Mídia', 'Fixos', 'Lucro Líquido'],
        datasets: [{
          label: 'R$',
          data: [s.revenue, -costCOGS, -media, -fixed, s.netProfit],
          borderWidth: 0,
          backgroundColor: [
            palette.revenue, palette.cogs, palette.media, palette.fixed, net >= 0 ? palette.netGood : palette.netBad
          ]
        }]
      };

      const funData = {
        labels: ['Leads', 'Vendas'],
        datasets: [{
          label: 'Quantidade',
          data: [s.leads, s.sales],
          borderWidth: 0,
          backgroundColor: [palette.leads, palette.sales]
        }]
      };

      if (!revChart) {
        revChart = new Chart(revCtx, {
          type: 'bar',
          data: revData,
          options: {
            responsive: true,
            plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => fmtBRL(ctx.parsed.y) } } },
            scales: {
              y: { ticks: { callback: v => fmtBRL(v) } }
            }
          }
        });
      } else {
        revChart.data = revData; revChart.update();
      }

      if (!funnelChart) {
        funnelChart = new Chart(funCtx, {
          type: 'bar',
          data: funData,
          options: {
            responsive: true,
            plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ctx.parsed.y.toLocaleString('pt-BR') } } },
            scales: { y: { ticks: { callback: v => v.toLocaleString('pt-BR') } } }
          }
        });
      } else {
        funnelChart.data = funData; funnelChart.update();
      }
    }

    function getPalette() {
      const light = document.documentElement.getAttribute('data-theme') === 'light';
      return {
        revenue: light ? '#34d399' : '#22c55e',
        cogs: light ? '#a78bfa' : '#7c3aed',
        media: light ? '#60a5fa' : '#3b82f6',
        fixed: light ? '#fbbf24' : '#f59e0b',
        netGood: light ? '#10b981' : '#10b981',
        netBad: light ? '#ef4444' : '#ef4444',
        leads: light ? '#93c5fd' : '#60a5fa',
        sales: light ? '#fca5a5' : '#ef4444',
      };
    }

    // =========================
    // SENSITIVITY TABLE
    // =========================
    function renderSensitivity(s) {
      const table = byId('sensiTable');
      const convBase = s.conv;
      const ticketBase = s.ticket;

      const convSteps = stepsAround(convBase, 5, 0, 100);
      const ticketSteps = stepsAround(ticketBase, 5, 0, 1e9);

      let thead = '<tr><th>Conv. \\ Ticket</th>';
      ticketSteps.forEach(t => { thead += `<th>${fmtBRL(t)}</th>`; });
      thead += '</tr>';

      let rows = '';
      convSteps.forEach(cv => {
        rows += `<tr><th>${cv.toFixed(2).replace('.',',')}%</th>`;
        ticketSteps.forEach(tk => {
          const revenue = simulateRevenue({ ...s }, cv, tk);
          const cls = revenue > s.revenue ? 'good' : (revenue === s.revenue ? 'mid' : 'bad');
          rows += `<td class="${cls}">${fmtBRL(revenue)}</td>`;
        });
        rows += '</tr>';
      });

      table.innerHTML = thead + rows;
    }

    function stepsAround(base, count, min, max) {
      const deltas = [0, 0.1, 0.2, 0.3, 0.4];
      return deltas.slice(0, count).map(d => clamp(base * (1 + d), min, max));
    }

    function simulateRevenue(state, convPct, ticketVal) {
      const convFactor = (convPct/100) * (1 - state.cancelPct/100);
      const sales = state.leads * convFactor;
      const revenue = sales * ticketVal * state.ltv;
      return revenue;
    }

    // =========================
    // ACTIONS
    // =========================
    byId('resetAll').addEventListener('click', () => {
      inputs.leadsNum.value = inputs.leadsRange.value = 0;
      inputs.convNum.value = inputs.convRange.value = 0;
      inputs.ticketNum.value = inputs.ticketRange.value = 0;
      inputs.cancelNum.value = inputs.cancelRange.value = 0;
      inputs.spendNum.value = inputs.spendRange.value = 0;
      inputs.marginNum.value = inputs.marginRange.value = 0;
      inputs.fixedNum.value = inputs.fixedRange.value = 0;
      inputs.targetRevenueNum.value = inputs.targetRevenueRange.value = 0;
      inputs.ltvNum.value = inputs.ltvRange.value = 1;

      inputs.salesAuto.checked = true;
      inputs.cplAuto.checked = true;

      setInitialDisabledStates();
      onChange();
    });

    function snapshotInputs() {
      return {
        leads: +inputs.leadsNum.value, conv: +inputs.convNum.value,
        salesAuto: inputs.salesAuto.checked, sales: +inputs.salesNum.value,
        ticket: +inputs.ticketNum.value, ltv: +inputs.ltvNum.value, cancel: +inputs.cancelNum.value,
        spend: +inputs.spendNum.value, cplAuto: inputs.cplAuto.checked, cpl: +inputs.cplNum.value,
        margin: +inputs.marginNum.value, fixed: +inputs.fixedNum.value,
        targetRevenue: +inputs.targetRevenueNum.value,
      };
    }

    function restoreInputs(i) {
      inputs.leadsNum.value = inputs.leadsRange.value = i.leads ?? 0;
      inputs.convNum.value = inputs.convRange.value = i.conv ?? 0;
      inputs.salesAuto.checked = !!i.salesAuto;
      inputs.salesNum.value = inputs.salesRange.value = i.sales ?? 0;
      inputs.ticketNum.value = inputs.ticketRange.value = i.ticket ?? 0;
      inputs.ltvNum.value = inputs.ltvRange.value = i.ltv ?? 1;
      inputs.cancelNum.value = inputs.cancelRange.value = i.cancel ?? 0;
      inputs.spendNum.value = inputs.spendRange.value = i.spend ?? 0;
      inputs.cplAuto.checked = !!i.cplAuto;
      inputs.cplNum.value = inputs.cplRange.value = i.cpl ?? 0;
      inputs.marginNum.value = inputs.marginRange.value = i.margin ?? 0;
      inputs.fixedNum.value = inputs.fixedRange.value = i.fixed ?? 0;
      inputs.targetRevenueNum.value = inputs.targetRevenueRange.value = i.targetRevenue ?? 0;
    }

    // Share link (querystring)
    byId('shareLink').addEventListener('click', () => {
      const i = snapshotInputs();
      const params = new URLSearchParams(i).toString();
      const url = `${location.origin}${location.pathname}?${params}`;
      navigator.clipboard.writeText(url).then(() => alert('Link copiado para a área de transferência!')).catch(() => alert(url));
    });

    // Export PNG
    byId('exportPNG').addEventListener('click', async () => {
        const nodeToCapture = byId('mainGrid');
        document.body.classList.add('is-exporting');

        const numInputs = nodeToCapture.querySelectorAll('.num');
        numInputs.forEach(input => {
            const overlay = document.createElement('div');
            overlay.className = 'export-overlay';
            overlay.textContent = input.value;
            
            const styles = getComputedStyle(input);
            Object.assign(overlay.style, {
                position: 'absolute', top: `${input.offsetTop}px`, left: `${input.offsetLeft}px`,
                width: `${input.offsetWidth}px`, height: `${input.offsetHeight}px`,
                color: styles.color, background: styles.background, font: styles.font,
                textAlign: styles.textAlign, padding: styles.padding, boxSizing: 'border-box',
                display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: '10',
            });
            input.parentElement.appendChild(overlay);
        });

        try {
            await new Promise(resolve => setTimeout(resolve, 100));

            const canvas = await html2canvas(nodeToCapture, { 
                scale: 2, useCORS: true,
            });
            
            const a = document.createElement('a');
            a.download = 'ng-calculadora-cenario.png';
            a.href = canvas.toDataURL('image/png');
            a.click();

        } catch (error) {
            console.error('Erro ao exportar PNG:', error);
            alert('Ocorreu um erro ao tentar exportar a imagem.');
        } finally {
            document.querySelectorAll('.export-overlay').forEach(el => el.remove());
            document.body.classList.remove('is-exporting');
        }
    });

    // Parse query params on load
    function applyQuery() {
      const q = new URLSearchParams(location.search);
      if ([...q.keys()].length === 0) return;
      const i = {
        leads: +q.get('leads'), conv: +q.get('conv'), salesAuto: q.get('salesAuto') === 'true',
        sales: +q.get('sales'), ticket: +q.get('ticket'), ltv: +q.get('ltv'),
        cancel: +q.get('cancel'), spend: +q.get('spend'), cplAuto: q.get('cplAuto') === 'true',
        cpl: +q.get('cpl'), margin: +q.get('margin'), fixed: +q.get('fixed'),
        targetRevenue: +q.get('targetRevenue'),
      };
      restoreInputs(i);
    }
    
    function setInitialDisabledStates(){
        inputs.salesNum.disabled = inputs.salesAuto.checked;
        inputs.salesRange.disabled = inputs.salesAuto.checked;
        inputs.cplNum.disabled = inputs.cplAuto.checked;
        inputs.cplRange.disabled = inputs.cplAuto.checked;
        inputs.leadsNum.disabled = !inputs.cplAuto.checked;
        inputs.leadsRange.disabled = !inputs.cplAuto.checked;
    }

    // INIT
    applyQuery();
    setInitialDisabledStates();
    onChange();

    // Reduz a sensibilidade do scroll nos campos numéricos
    document.querySelectorAll('.num').forEach(input => {
        input.addEventListener('wheel', (e) => {
            e.preventDefault();
        });
    });
  </script>
</body>
</html>

